# –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã M2 Middleware

**–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2024  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É (–∂–¥—ë–º —Ç–æ–∫–µ–Ω)

---

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û

### 1. –î–æ–º–µ–Ω –∏ SSL
- ‚úÖ –î–æ–º–µ–Ω maslahub.ru –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É 89.223.125.212
- ‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ 10 –º–∞—Ä—Ç–∞ 2026)
- ‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ –ø–æ—Ä—Ç 3001
- ‚úÖ –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç:
  - https://maslahub.ru/m2/health
  - https://maslahub.ru/m2/webhook
  - https://maslahub.ru/m2/api/mapping/stats
  - https://maslahub.ru/m2/api/mapping/summary

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ú–æ–π–°–∫–ª–∞–¥
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ 1014 –≤ API –ú–æ–π–°–∫–ª–∞–¥
- ‚úÖ Webhook –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏—ë–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞—Ç–∫–æ–≤
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 3. –ò–∑–æ–ª—è—Ü–∏—è M1 –∏ M2
- ‚úÖ **Campaign ID - –≥–ª–∞–≤–Ω–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è –∏–∑–æ–ª—è—Ü–∏–∏**
- ‚úÖ M1 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ú–æ–π–°–∫–ª–∞–¥
- ‚úÖ M2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–π–ª–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥
- ‚úÖ Middleware –ù–ï —á–∏—Ç–∞–µ—Ç product.offerId –∏–∑ –ú–æ–π–°–∫–ª–∞–¥
- ‚úÖ offerId –≤ –º–∞–ø–ø–∏–Ω–≥–µ –º–æ–≥—É—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å M1 - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ä–∞–∑–Ω—ã–º–∏ Campaign ID

### 4. –ú–∞–ø–ø–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ 101 —Ç–æ–≤–∞—Ä –≤ –º–∞–ø–ø–∏–Ω–≥–µ
- ‚úÖ –í—Å–µ offerId –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –º–∞–≥–∞–∑–∏–Ω–∞
- ‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞

---

## ‚è≥ –ß–¢–û –ñ–î–Å–ú

### YANDEX_TOKEN
- ‚è≥ –ñ–¥—ë–º —Ç–æ–∫–µ–Ω –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–∞ M2
- ‚è≥ –¢–æ–∫–µ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç API
- ‚úÖ –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤: `update-yandex-token.sh`

**–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω:**
```bash
bash update-yandex-token.sh
# –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∫–æ–≥–¥–∞ —Å–∫—Ä–∏–ø—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç
```

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:

1. **–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω**
   ```bash
   bash update-yandex-token.sh
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä**
   ```bash
   ssh root@89.223.125.212
   cd /root/maslahub
   pm2 restart maslahub-m2
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**
   ```bash
   pm2 logs maslahub-m2
   ```

4. **–¢–µ—Å—Ç–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 1 —Ç–æ–≤–∞—Ä–∞**
   - –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `SAFE_LAUNCH_CHECKLIST.md`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ—Å—Ç–∞—Ç–æ–∫ –æ–±–Ω–æ–≤–∏–ª—Å—è –≤ M2
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ M1 –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç

5. **–í–∫–ª—é—á–∏—Ç—å webhook –≤ –ú–æ–π–°–∫–ª–∞–¥**
   - URL: `https://maslahub.ru/m2/webhook`
   - –°–æ–±—ã—Ç–∏—è: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
   - –ú–µ—Ç–æ–¥: POST

6. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–≤—ã—Ö —á–∞—Å–æ–≤**
   ```bash
   tail -f /root/maslahub/logs/combined.log
   ```

---

## üìä –¢–ï–ö–£–©–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –°–µ—Ä–≤–µ—Ä
- **IP:** 89.223.125.212
- **–î–æ–º–µ–Ω:** maslahub.ru
- **–ü–æ—Ä—Ç:** 3001
- **SSL:** ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω

### –¢–æ–∫–µ–Ω—ã
- **MS_TOKEN:** ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω
- **YANDEX_CAMPAIGN_ID:** ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω (198473170)
- **YANDEX_TOKEN:** ‚è≥ –ñ–¥—ë–º

### –ú–∞–ø–ø–∏–Ω–≥
- **–§–∞–π–ª:** data/product-mappings.json
- **–¢–æ–≤–∞—Ä–æ–≤:** 101
- **–í–µ—Ä—Å–∏—è:** 1.0.0

---

## üîê –ì–ê–†–ê–ù–¢–ò–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### –ò–∑–æ–ª—è—Ü–∏—è M1 –∏ M2
1. ‚úÖ **–†–∞–∑–Ω—ã–µ Campaign ID** - –≥–ª–∞–≤–Ω–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è!
2. ‚úÖ –†–∞–∑–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
3. ‚úÖ –†–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (product.offerId vs —Ñ–∞–π–ª)
4. ‚úÖ Middleware –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç product.offerId
5. ‚úÖ offerId –º–æ–≥—É—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å - Campaign ID —Ä–∞–∑–¥–µ–ª—è–µ—Ç –º–∞–≥–∞–∑–∏–Ω—ã

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
- ‚úÖ –ö–æ–¥ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç —á—Ç–µ–Ω–∏—è product.offerId
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —Å Campaign ID M2
- ‚úÖ –¢–æ–≤–∞—Ä—ã –±–µ–∑ –º–∞–ø–ø–∏–Ω–≥–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
- ‚úÖ M1 –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è middleware

---

## üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- `M1_M2_ISOLATION_GUARANTEES.md` - –ì–∞—Ä–∞–Ω—Ç–∏–∏ –∏–∑–æ–ª—è—Ü–∏–∏ M1 –∏ M2
- `SAFE_LAUNCH_CHECKLIST.md` - –ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- `update-yandex-token.sh` - –°–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- `SETUP_YANDEX_TOKEN.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é —Ç–æ–∫–µ–Ω–∞

---

## üí¨ –í–ê–ñ–ù–´–ï –£–¢–û–ß–ù–ï–ù–ò–Ø

### offerId –≤ –º–∞–ø–ø–∏–Ω–≥–µ
- ‚ùå –ù–ï –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω—ã –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `_DBSA`
- ‚úÖ –ú–æ–≥—É—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å product.offerId –≤ M1
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è Campaign ID, –∞ –Ω–µ offerId!**
- ‚úÖ –ù–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Ä–∞–∑–Ω—ã–º–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç–ª–∞–¥–∫–∏

### Webhook vs Polling
- **–ú–æ–π–°–∫–ª–∞–¥ ‚Üí M2:** Webhook (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
- **M2 ‚Üí –ú–æ–π–°–∫–ª–∞–¥:** Polling –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ API)
- **–Ø–Ω–¥–µ–∫—Å M2 –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ webhook** - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ

---

## ‚úÖ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ó–ê–ü–£–°–ö–£

- [x] –°–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] SSL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [x] Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] –ú–∞–ø–ø–∏–Ω–≥ –∑–∞–≥—Ä—É–∂–µ–Ω
- [x] –ò–∑–æ–ª—è—Ü–∏—è M1/M2 –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
- [x] –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] **YANDEX_TOKEN –ø–æ–ª—É—á–µ–Ω** ‚è≥

**–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å!** üöÄ

---

**–í—Å—ë –≥–æ—Ç–æ–≤–æ! –ñ–¥—ë–º —Ç–æ–∫–µ–Ω –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–∞.** üí™
