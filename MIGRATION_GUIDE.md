# Руководство по миграции данных в продакшене

## Обзор

Этот документ описывает процесс миграции маппинга `product.id → offerId` из кастомных атрибутов МойСклад в файловое хранилище.

## Предварительные требования

### 1. Действующий токен МойСклад API

Для выполнения миграции необходим действующий токен доступа к API МойСклад с правами на чтение товаров и их атрибутов.

**Как получить токен:**
1. Войдите в МойСклад
2. Перейдите в Настройки → Пользователи и права
3. Создайте нового пользователя или используйте существующего
4. Сгенерируйте токен доступа
5. Обновите файл `.env`:
   ```
   MS_TOKEN=ваш_действующий_токен_здесь
   ```

### 2. Резервное копирование

Перед миграцией убедитесь, что у вас есть резервные копии:
- Текущего файла `data/product-mappings.json`
- Базы данных (если используется)
- Конфигурационных файлов

## Процесс миграции

### Шаг 1: Создание резервной копии

Резервная копия уже создана автоматически:
```bash
data/product-mappings.backup.20251205_110542.json
```

Скрипт миграции также создаст дополнительную копию в директории `data/backups/`.

### Шаг 2: Обновление токена МойСклад

Откройте файл `.env` и обновите токен:
```bash
MS_TOKEN=ваш_действующий_токен_здесь
```

### Шаг 3: Запуск миграции

Выполните команду:
```bash
node scripts/migrate-to-file-mapping.js --backup --validate
```

**Опции:**
- `--backup` - создать резервную копию перед миграцией
- `--validate` - валидировать маппинги после миграции
- `--help` - показать справку

### Шаг 4: Проверка результатов

После успешной миграции скрипт выведет статистику:
```
============================================================
СТАТИСТИКА МИГРАЦИИ
============================================================
Всего товаров обработано:     XXX
Маппингов мигрировано:        XXX
Товаров пропущено:            XXX
Ошибок при обработке:         XXX
Длительность:                 XXXс
============================================================
```

### Шаг 5: Валидация маппинга

Если использовалась опция `--validate`, скрипт проверит:
- Корректность структуры JSON
- Отсутствие дубликатов offerId
- Отсутствие пустых значений
- Валидность UUID для product.id

Результаты валидации:
```
============================================================
РЕЗУЛЬТАТЫ ВАЛИДАЦИИ
============================================================
Статус:                       ✓ ВАЛИДНО
Всего маппингов:              XXX
Валидных маппингов:           XXX
Невалидных маппингов:         0
Дубликатов offerId:           0
Пустых значений:              0
============================================================
```

### Шаг 6: Проверка файла маппинга

Откройте файл `data/product-mappings.json` и проверьте его содержимое:

```json
{
  "version": "1.0",
  "lastUpdated": "2025-12-05T08:05:54.423Z",
  "mappings": {
    "f8a2da33-bf0a-11ef-0a80-17e3002d7201": "8100-X-clean-EFE-5w-30-5L_DBSA",
    "a1b2c3d4-e5f6-11ef-0a80-17e3002d7202": "8100-X-clean-C3-5w-40-5L_DBSA"
  }
}
```

Убедитесь что:
- Все ожидаемые товары присутствуют
- Значения offerId корректны
- Нет дубликатов

### Шаг 7: Обновление конфигурации

Конфигурация уже настроена для использования файлового маппинга в `src/config.js`:

```javascript
PRODUCT_MAPPING_FILE: process.env.PRODUCT_MAPPING_FILE || './data/product-mappings.json'
```

Проверьте файл `.env`:
```bash
PRODUCT_MAPPING_FILE=./data/product-mappings.json
```

### Шаг 8: Перезапуск middleware

После успешной миграции перезапустите middleware:

```bash
# Остановите текущий процесс
pm2 stop m2-middleware  # или используйте ваш процесс-менеджер

# Запустите заново
pm2 start src/server.js --name m2-middleware

# Проверьте логи
pm2 logs m2-middleware
```

### Шаг 9: Мониторинг

После перезапуска следите за логами на наличие:
- Успешной загрузки маппингов при старте
- Корректной обработки webhook
- Успешной синхронизации остатков
- Отсутствия ошибок маппинга

Проверьте логи:
```bash
tail -f logs/combined.log | grep -i mapping
```

## Устранение проблем

### Ошибка 401: Неверные учетные данные

**Проблема:** Токен МойСклад недействителен или истек.

**Решение:**
1. Получите новый токен в МойСклад
2. Обновите `.env` файл
3. Запустите миграцию снова

### Ошибка: Файл маппинга не найден

**Проблема:** Отсутствует файл `data/product-mappings.json`.

**Решение:**
1. Создайте файл вручную из примера:
   ```bash
   cp data/product-mappings.example.json data/product-mappings.json
   ```
2. Запустите миграцию

### Ошибка: Невалидные маппинги

**Проблема:** Валидация обнаружила проблемы в маппингах.

**Решение:**
1. Проверьте вывод валидации
2. Исправьте проблемные записи вручную в файле
3. Запустите валидацию снова:
   ```bash
   node scripts/migrate-to-file-mapping.js --validate
   ```

### Дубликаты offerId

**Проблема:** Несколько product.id ссылаются на один offerId.

**Решение:**
1. Проверьте данные в МойСклад
2. Убедитесь что каждый товар имеет уникальный offerId
3. Исправьте дубликаты
4. Запустите миграцию снова

## Откат миграции

Если что-то пошло не так, вы можете откатить изменения:

```bash
# Восстановить из резервной копии
cp data/product-mappings.backup.20251205_110542.json data/product-mappings.json

# Или из автоматической копии
cp data/backups/product-mappings-backup-2025-12-05T08-05-54-423Z.json data/product-mappings.json

# Перезапустить middleware
pm2 restart m2-middleware
```

## Проверка успешности миграции

После миграции выполните следующие проверки:

### 1. Проверка загрузки маппингов
```bash
# Проверьте логи при старте
grep "Загружено маппингов" logs/combined.log
```

### 2. Проверка синхронизации остатков
```bash
# Запустите тестовую синхронизацию
curl http://localhost:3000/api/sync-stocks

# Проверьте логи
tail -f logs/combined.log
```

### 3. Проверка обработки webhook
```bash
# Отправьте тестовый webhook (замените на реальный product.id)
curl -X POST http://localhost:3000/webhook/moysklad \
  -H "Content-Type: application/json" \
  -d '{
    "events": [{
      "meta": {
        "type": "product",
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/product/f8a2da33-bf0a-11ef-0a80-17e3002d7201"
      },
      "action": "UPDATE"
    }]
  }'
```

### 4. Проверка статистики
```bash
# Получите статистику маппинга
curl http://localhost:3000/api/stats
```

## Следующие шаги

После успешной миграции:

1. ✅ Резервная копия создана
2. ⏳ Миграция выполнена (требуется действующий токен)
3. ⏳ Файл маппинга проверен
4. ⏳ Маппинг валидирован
5. ✅ Конфигурация обновлена
6. ⏳ Middleware перезапущен
7. ⏳ Мониторинг настроен

## Контрольный список

- [ ] Получен действующий токен МойСклад API
- [ ] Обновлен файл `.env` с новым токеном
- [ ] Создана резервная копия текущих данных
- [ ] Запущен скрипт миграции с опциями `--backup --validate`
- [ ] Проверена статистика миграции
- [ ] Проверены результаты валидации
- [ ] Проверен файл `data/product-mappings.json`
- [ ] Перезапущен middleware
- [ ] Проверены логи на наличие ошибок
- [ ] Выполнена тестовая синхронизация остатков
- [ ] Выполнена тестовая обработка webhook
- [ ] Настроен мониторинг

## Поддержка

При возникновении проблем:
1. Проверьте логи в `logs/combined.log` и `logs/error.log`
2. Проверьте документацию в `docs/product-mapping-guide.md`
3. Используйте `--help` для справки по скрипту миграции
4. Обратитесь к разработчикам с деталями ошибки

