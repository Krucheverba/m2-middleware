# Архитектура: Потоки данных

## Принцип работы

Middleware обеспечивает **однонаправленные специализированные потоки данных** между системами с использованием файлового маппинга:

```
┌─────────────────────────────────────────────────────────────┐
│                  МойСклад (единая база)                      │
│                                                              │
│  Товар: product.id = "f8a2da33-bf0a-11ef-0a80-17e3..."      │
│         product.offerId = "8100-X-clean-EFE-5w-30-5L"       │
└─────────────────────────────────────────────────────────────┘
           │                                    │
           │ Встроенная                         │ Webhook
           │ интеграция                         │ (product.id)
           ▼                                    ▼
    ┌──────────┐                         ┌──────────────────┐
    │ M1       │                         │ Middleware       │
    │          │                         │                  │
    │ offerId: │                         │ Mapping Table:   │
    │ "8100-   │                         │ product.id →     │
    │  X-clean"│                         │ offerId          │
    └──────────┘                         │                  │
           │                             │ "f8a2da33..." →  │
           │                             │ "8100-X-clean_   │
           │                             │  DBSA"           │
           ▼                             └──────────────────┘
    Яндекс M1                                    │
    Campaign ID: XXX                             ▼
                                          Яндекс M2
                                          Campaign ID: YYY
                                          offerId: "8100-X-clean_DBSA"
```

## Поток 1: МойСклад → M2 (Остатки)

### Что передаётся
- ✅ `offerId` - идентификатор товара в M2 (из файлового маппинга)
- ✅ `count` - количество доступного товара

### Что НЕ передаётся
- ❌ `product.id` - UUID товара в МойСклад
- ❌ `product.offerId` - стандартное поле МойСклад (используется M1)
- ❌ Название товара
- ❌ Цена
- ❌ Описание
- ❌ Категория
- ❌ Любые другие атрибуты товара

### Механизмы передачи

#### 1. Webhook (реального времени)
```javascript
МойСклад → Webhook → Middleware → StockService → M2

// Что происходит:
1. МойСклад отправляет webhook о изменении остатка (содержит product.id)
2. Middleware извлекает product.id из webhook payload
3. MapperService преобразует product.id → offerId (через файловый маппинг)
4. StockService отправляет в M2 ТОЛЬКО offerId и count
```

#### 2. Cron Job (резервный механизм)
```javascript
Cron → StockService → МойСклад API → MapperService → M2

// Что происходит:
1. Каждые 10-15 минут запускается cron job
2. Получаем список product.id из файлового маппинга
3. Запрашиваем остатки из МойСклад по product.id
4. Преобразуем product.id → offerId (через файловый маппинг)
5. Отправляем в M2 ТОЛЬКО offerId и count
```

### Пример данных

**Webhook от МойСклад:**
```json
{
  "events": [{
    "meta": {
      "type": "product",
      "href": "https://api.moysklad.ru/api/remap/1.2/entity/product/f8a2da33-bf0a-11ef-0a80-17e3002d7201"
    },
    "action": "UPDATE"
  }]
}
```

**Извлечение product.id:**
```javascript
const productId = event.meta.href.split('/').pop();
// "f8a2da33-bf0a-11ef-0a80-17e3002d7201"
```

**Маппинг через файл:**
```json
{
  "mappings": {
    "f8a2da33-bf0a-11ef-0a80-17e3002d7201": "8100-X-clean-EFE-5w-30-5L_DBSA"
  }
}
```

**В M2 (после фильтрации):**
```json
{
  "sku": "8100-X-clean-EFE-5w-30-5L_DBSA",
  "warehouseId": 0,
  "items": [{
    "count": 20,
    "type": "FIT"
  }]
}
```

## Поток 2: M2 → МойСклад (Заказы)

### Что передаётся
- ✅ Заказы с товарами (offerId → product.id через обратный маппинг)
- ✅ Количество товаров
- ✅ Информация о покупателе (если есть)
- ✅ Статус заказа (для резервирования)

### Что НЕ передаётся в обратную сторону
- ❌ Внутренние ID заказов МойСклад не возвращаются в M2
- ❌ Детали складского учёта

### Механизм передачи

#### Polling (опрос M2)
```javascript
Cron → OrderService → M2 API → MapperService → МойСклад

// Что происходит:
1. Каждые 5-10 минут опрашиваем M2 на новые заказы
2. Получаем заказы с offerId товаров
3. MapperService преобразует offerId → product.id (через обратный маппинг)
4. OrderService создаёт заказ покупателя в МойСклад с product.id
5. Сохраняем маппинг заказа (M2 ID ↔ МойСклад ID)
```

### Пример данных

**Из M2:**
```json
{
  "id": "M2-ORDER-12345",
  "status": "PROCESSING",
  "items": [
    {
      "offerId": "8100-X-clean-EFE-5w-30-5L_DBSA",
      "count": 2,
      "price": 5000
    }
  ],
  "delivery": {
    "recipient": "Иван Иванов",
    "address": "Москва, ул. Ленина, 1"
  }
}
```

**Обратный маппинг через файл:**
```javascript
const productId = mapperService.mapOfferIdToProductId("8100-X-clean-EFE-5w-30-5L_DBSA");
// "f8a2da33-bf0a-11ef-0a80-17e3002d7201"
```

**В МойСклад (после маппинга):**
```json
{
  "name": "Заказ M2-ORDER-12345",
  "positions": [
    {
      "assortment": {
        "meta": {
          "href": "https://api.moysklad.ru/api/remap/1.2/entity/product/f8a2da33-bf0a-11ef-0a80-17e3002d7201",
          "type": "product"
        }
      },
      "quantity": 2,
      "price": 500000,
      "reserve": 2
    }
  ],
  "agent": {
    "meta": {
      "href": "https://api.moysklad.ru/api/remap/1.2/entity/counterparty/..."
    }
  }
}
```

## Поток 3: M2 → МойСклад (Отгрузки)

### Что передаётся
- ✅ Статус "SHIPPED" из M2
- ✅ Ссылка на заказ покупателя в МойСклад (через маппинг)

### Механизм передачи

```javascript
Cron → OrderService → M2 API → OrderMappingStore → МойСклад

// Что происходит:
1. Опрашиваем M2 на заказы со статусом SHIPPED
2. Получаем M2 order ID
3. Находим соответствующий МойСклад order ID через маппинг
4. Создаём отгрузку в МойСклад
5. Закрываем заказ покупателя
```

## Изоляция данных

### Что знает M2
- ✅ Свои offerId (из файлового маппинга)
- ✅ Остатки товаров (count)
- ✅ Статусы своих заказов

### Что НЕ знает M2
- ❌ product.id из МойСклад
- ❌ product.offerId из МойСклад (используется M1)
- ❌ Названия товаров из МойСклад
- ❌ Цены в МойСклад
- ❌ Внутренние ID заказов МойСклад
- ❌ Структуру складов МойСклад

### Что знает МойСклад
- ✅ Свои product.id (UUID товаров)
- ✅ Свои товары со всеми атрибутами
- ✅ Стандартное поле product.offerId (используется M1)
- ✅ Заказы покупателей
- ✅ Отгрузки

### Что НЕ знает МойСклад
- ❌ Внутреннюю структуру M2
- ❌ offerId для M2 (хранится в файле маппинга)
- ❌ Другие магазины на M2
- ❌ Детали работы M2

### Изоляция M1 и M2

- **M1**: Использует `product.offerId` = `"8100-X-clean-EFE-5w-30-5L"` + Campaign ID M1
- **M2**: Использует маппинг → `offerId` = `"8100-X-clean-EFE-5w-30-5L_DBSA"` + Campaign ID M2
- **Результат**: Полная изоляция, разные offerId, разные Campaign ID
- **Middleware не читает product.offerId!** Только маппинг из файла

## Middleware как посредник

Middleware выполняет роль **изолирующего слоя**:

1. **Файловый маппинг**: product.id ↔ offerId через `data/product-mappings.json`
2. **Фильтрация данных**: Передаёт только необходимое
3. **Преобразование форматов**: M2 API ↔ МойСклад API
4. **Хранение связей**: Маппинги заказов
5. **Логирование**: Отслеживание всех операций
6. **Изоляция M1/M2**: Разные offerId для одного товара

## Безопасность

### Принципы
1. **Минимизация данных**: Передаём только необходимое
2. **Изоляция систем**: Системы не знают о внутренностях друг друга
3. **Однонаправленность**: Каждый поток имеет чёткое назначение
4. **Маппинг на границе**: Преобразование происходит в middleware

### Что логируется
```javascript
// ✅ Правильно - раздельное логирование
logger.info('Остатки получены из МойСклад', {
  productId: 'f8a2da33-bf0a-11ef-0a80-17e3002d7201',
  count: 20
});

logger.info('Остатки отправлены в M2', {
  offerId: '8100-X-clean-EFE-5w-30-5L_DBSA',
  count: 20
});

// ❌ Неправильно - связывание данных в логах
logger.info('Синхронизация остатков', {
  productId: 'f8a2da33-bf0a-11ef-0a80-17e3002d7201',  // Не должно быть вместе!
  offerId: '8100-X-clean-EFE-5w-30-5L_DBSA',          // Не должно быть вместе!
  count: 20
});
```

## Диаграмма последовательности

### Синхронизация остатков (МойСклад → M2)

```
МойСклад          Middleware                M2
    |                  |                     |
    |-- Webhook ------>|                     |
    |  (product.id)    |                     |
    |                  |                     |
    |                  |-- Map ------------->|
    |                  |  product.id         |
    |                  |  → offerId          |
    |                  |  (file mapping)     |
    |                  |                     |
    |                  |-- Update Stock ---->|
    |                  |  (offerId, count)   |
    |                  |                     |
    |                  |<----- OK -----------|
    |<----- OK --------|                     |
```

### Создание заказа (M2 → МойСклад)

```
M2              Middleware              МойСклад
 |                  |                      |
 |<-- Poll ---------|                      |
 |                  |                      |
 |-- New Order ---->|                      |
 |  (offerId)       |                      |
 |                  |                      |
 |                  |-- Reverse Map ------>|
 |                  |  offerId             |
 |                  |  → product.id        |
 |                  |  (file mapping)      |
 |                  |                      |
 |                  |-- Create Order ----->|
 |                  |  (product.id)        |
 |                  |                      |
 |                  |<----- Order ID ------|
 |                  |                      |
 |                  |-- Save Mapping ----->|
 |                  |  (M2 ID ↔ MS ID)     |
```

## Заключение

Эта архитектура обеспечивает:
- ✅ Чёткое разделение ответственности
- ✅ Минимизацию передаваемых данных
- ✅ Изоляцию систем друг от друга
- ✅ Безопасность данных
- ✅ Простоту отладки и мониторинга
