# План реализации

- [x] 1. Настроить инфраструктуру проекта и конфигурацию
  - Создать модуль конфигурации, который загружает переменные окружения (YANDEX_CAMPAIGN_ID, YANDEX_TOKEN, MS_TOKEN, MS_BASE, STOCK_SYNC_INTERVAL_MINUTES, ORDER_POLL_INTERVAL_MINUTES, LOG_LEVEL)
  - Реализовать валидацию обязательных параметров при запуске
  - Настроить Winston logger с настраиваемыми уровнями логирования
  - Создать структуру директорий для файла маппинга заказов
  - _Требования: 7.1, 7.2, 7.5_

- [ ]* 1.1 Написать property-тест для валидации конфигурации
  - **Property 23: Отсутствие конфигурации предотвращает запуск**
  - **Проверяет: Требования 7.2**

- [ ]* 1.2 Написать property-тест для безопасности учётных данных
  - **Property 24: Учётные данные никогда не логируются**
  - **Проверяет: Требования 7.3**

- [ ]* 1.3 Написать property-тест для уровня логирования
  - **Property 25: Уровень логирования соблюдается**
  - **Проверяет: Требования 7.5**

- [x] 2. Реализовать хранилище маппинга заказов
  - Создать класс OrderMappingStore с файловым хранилищем
  - Реализовать метод save() для записи маппингов в JSON файл
  - Реализовать метод get() для получения маппингов по ID заказа M2
  - Реализовать метод exists() для проверки дубликатов
  - Добавить механизм блокировки файла для предотвращения конфликтов при одновременной записи
  - _Требования: 8.1, 8.2, 8.4_

- [ ]* 2.1 Написать property-тест для round trip маппинга заказов
  - **Property 26: Маппинги заказов можно получить обратно**
  - **Проверяет: Требования 8.2**

- [ ]* 2.2 Написать property-тест для предотвращения дубликатов
  - **Property 27: Дубликаты маппингов не создаются**
  - **Проверяет: Требования 8.4**

- [ ]* 2.3 Написать property-тест для обработки ошибок файла
  - **Property 28: Ошибки файла не роняют систему**
  - **Проверяет: Требования 8.5**

- [x] 3. Реализовать API клиенты
- [x] 3.1 Создать API клиент МойСклад
  - Реализовать класс MoySkladClient с использованием axios
  - Добавить метод getProductAttributes() для получения метаданных и поиска ID атрибута offerId_M2
  - Добавить метод getProducts() для получения товаров с параметром expand=attributes
  - Добавить метод getProductStock() используя endpoint /report/stock/bystore с правильным парсингом ответа
  - Добавить метод createCustomerOrder() для создания заказов с резервированием товаров
  - Добавить метод createShipment() для создания отгрузок
  - Добавить метод updateOrderStatus() для закрытия заказов
  - Реализовать аутентификацию через Bearer token (MS_TOKEN)
  - Добавить заголовок Accept-Encoding: gzip для всех запросов
  - Добавить обработку ошибок и логирование для всех API вызовов
  - _Требования: 1.5, 2.1, 3.1, 3.4_

- [x] 3.2 Создать API клиент Яндекс.Маркет
  - Реализовать класс YandexClient с использованием axios
  - Добавить метод updateStocks() для пакетного обновления остатков (до 2000 товаров)
  - Добавить метод getOrders() для получения заказов с фильтрацией по статусу
  - Добавить метод getOrder() для получения деталей конкретного заказа
  - Реализовать аутентификацию используя YANDEX_TOKEN и YANDEX_CAMPAIGN_ID
  - Добавить обработку ошибок и логирование для всех API вызовов
  - Реализовать обработку rate limiting с логикой повторных попыток
  - _Требования: 1.1, 2.1, 3.1, 9.3_

- [ ]* 3.3 Написать property-тест для логирования ошибок API
  - **Property 19: Ошибки API включают детали запроса**
  - **Проверяет: Требования 6.2**

- [ ]* 3.4 Написать property-тест для обработки rate limiting
  - **Property 31: Rate limits соблюдаются**
  - **Проверяет: Требования 9.3**

- [x] 4. Реализовать сервис маппинга
  - Создать класс MapperService
  - Реализовать метод getOfferIdAttributeId() для получения ID атрибута offerId_M2 из метаданных МойСклад при запуске
  - Реализовать метод loadMappings() для получения товаров из МойСклад с expand=attributes и построения кэша маппинга в памяти
  - Парсить значение атрибута offerId_M2 из массива attributes товара используя ID атрибута
  - Реализовать метод mapOfferIdToExternalCode() для маппинга M2 → МойСклад
  - Реализовать метод mapExternalCodeToOfferId() для маппинга МойСклад → M2
  - Реализовать метод saveOrderMapping() для сохранения маппингов заказов
  - Реализовать метод getMoySkladOrderId() для получения маппингов заказов
  - Добавить логирование ошибок для отсутствующих маппингов
  - _Требования: 1.5, 2.2, 8.1, 8.2_

- [ ]* 4.1 Написать property-тест для SKU маппинга
  - **Property 4: ExternalCode правильно маппится на offerId_M2**
  - **Проверяет: Требования 1.5**

- [ ]* 4.2 Написать property-тест для ошибок отсутствующего маппинга
  - **Property 18: Ошибки отсутствующего маппинга включают идентификаторы**
  - **Проверяет: Требования 6.1**

- [x] 5. Реализовать сервис синхронизации остатков
- [x] 5.1 Создать класс StockService
  - Реализовать метод handleStockWebhook() для обработки webhook событий от МойСклад
  - Реализовать метод syncAllStocks() для резервного cron job
  - Использовать endpoint /report/stock/bystore для получения точных остатков
  - Парсить массив stockByStore и вычислять общий остаток по всем складам
  - Вычислять доступный остаток (общий остаток - общий резерв)
  - Реализовать метод updateM2Stock() для обновления остатка одного товара в Яндекс.Маркет
  - Добавить фильтрацию для обработки только товаров с валидным маппингом offerId_M2
  - Добавить обработку ошибок для товаров без маппинга
  - _Требования: 1.1, 1.2, 1.3, 1.4, 5.2_

- [ ]* 5.2 Написать property-тест для обновления остатков через webhook
  - **Property 1: Webhook остатков обновляет M2**
  - **Проверяет: Требования 1.1**

- [ ]* 5.3 Написать property-тест для фильтрации маппированных товаров
  - **Property 2: Синхронизируются только маппированные товары**
  - **Проверяет: Требования 1.3, 5.1**

- [ ]* 5.4 Написать property-тест для обработки немаппированных товаров
  - **Property 3: Немаппированные товары пропускаются с ошибками**
  - **Проверяет: Требования 1.4**

- [ ]* 5.5 Написать property-тест для обработки cron job
  - **Property 5: Cron job обрабатывает все маппированные товары**
  - **Проверяет: Требования 5.2**

- [x] 6. Реализовать сервис переноса заказов
- [x] 6.1 Создать класс OrderService
  - Реализовать метод pollAndProcessOrders() для получения новых заказов из M2
  - Реализовать метод createMoySkladOrder() для создания заказов покупателя в МойСклад
  - Добавить SKU маппинг для всех позиций заказа используя MapperService
  - Добавить валидацию для проверки что все товары маппированы перед созданием заказа
  - Реализовать сохранение маппинга заказа после успешного создания
  - Добавить обработку ошибок для заказов с немаппированными товарами
  - _Требования: 2.1, 2.2, 2.3, 2.4, 5.3_

- [ ]* 6.2 Написать property-тест для создания заказа
  - **Property 6: Новые заказы M2 создают заказы в МойСклад**
  - **Проверяет: Требования 2.1**

- [ ]* 6.3 Написать property-тест для маппинга позиций заказа
  - **Property 7: Позиции заказа маппятся правильно**
  - **Проверяет: Требования 2.2**

- [ ]* 6.4 Написать property-тест для флагирования немаппированных товаров
  - **Property 8: Заказы с немаппированными товарами флагируются**
  - **Проверяет: Требования 2.3**

- [ ]* 6.5 Написать property-тест для сохранения маппинга заказов
  - **Property 9: Маппинги заказов сохраняются**
  - **Проверяет: Требования 2.4, 8.1**

- [ ]* 6.6 Написать property-тест для polling заказов
  - **Property 10: Polling заказов получает новые заказы**
  - **Проверяет: Требования 5.3**

- [ ]* 6.7 Написать property-тест для логирования ошибок немаппированных товаров
  - **Property 20: Ошибки немаппированных товаров включают контекст заказа**
  - **Проверяет: Требования 6.3**

- [x] 7. Реализовать сервис переноса отгрузок
- [x] 7.1 Добавить обработку отгрузок в OrderService
  - Реализовать метод processShippedOrders() для polling M2 на отгруженные заказы
  - Реализовать метод createShipment() для создания отгрузок в МойСклад
  - Добавить поиск маппинга заказа для нахождения соответствующего заказа в МойСклад
  - Реализовать обновление статуса заказа для закрытия заказа покупателя после отгрузки
  - Добавить обработку ошибок для неизвестных ID заказов
  - _Требования: 3.1, 3.2, 3.4, 3.5_

- [ ]* 7.2 Написать property-тест для создания отгрузки
  - **Property 11: Отгруженные заказы создают отгрузки**
  - **Проверяет: Требования 3.1**

- [ ]* 7.3 Написать property-тест для ссылки на заказ в отгрузке
  - **Property 12: Отгрузки ссылаются на правильные заказы**
  - **Проверяет: Требования 3.2, 8.2**

- [ ]* 7.4 Написать property-тест для обновления статуса заказа
  - **Property 13: Статус заказа обновляется после отгрузки**
  - **Проверяет: Требования 3.4**

- [ ]* 7.5 Написать property-тест для обработки неизвестных заказов
  - **Property 14: Неизвестные заказы пропускаются**
  - **Проверяет: Требования 3.5**

- [x] 8. Реализовать webhook endpoint
  - Создать Express.js сервер с webhook маршрутом
  - Реализовать POST /webhook/moysklad endpoint
  - Добавить валидацию подлинности webhook
  - Реализовать извлечение данных webhook для изменений остатков
  - Вызывать StockService.handleStockWebhook() для обработки
  - Добавить обработку ошибок и логирование
  - _Требования: 4.1, 4.2, 4.4_

- [ ]* 8.1 Написать property-тест для валидации webhook
  - **Property 15: Невалидные webhook отклоняются**
  - **Проверяет: Требования 4.1**

- [ ]* 8.2 Написать property-тест для извлечения данных webhook
  - **Property 16: Данные webhook извлекаются правильно**
  - **Проверяет: Требования 4.2**

- [x] 9. Реализовать cron планировщик
  - Создать класс CronScheduler используя node-cron
  - Реализовать scheduleStockSync() для запуска синхронизации остатков с настроенным интервалом
  - Реализовать scheduleOrderPolling() для запуска polling заказов с настроенным интервалом
  - Добавить обработку ошибок чтобы cron jobs продолжали работу после ошибок
  - Добавить логирование для выполнения cron jobs
  - _Требования: 5.3, 5.4, 5.5_

- [ ]* 9.1 Написать property-тест для обработки ошибок cron
  - **Property 17: Ошибки cron не останавливают выполнение**
  - **Проверяет: Требования 5.5**

- [x] 10. Реализовать комплексное логирование ошибок
  - Добавить структурированное логирование для всех типов ошибок
  - Убедиться что все логи ошибок включают timestamp, тип ошибки и идентификаторы
  - Реализовать санитизацию логов для удаления учётных данных
  - Добавить специфичное логирование ошибок для сбоев маппинга, ошибок API и ошибок файлов
  - Настроить фильтрацию уровня логирования на основе переменной окружения LOG_LEVEL
  - _Требования: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 10.1 Написать property-тест для структуры лога ошибок
  - **Property 21: Логи ошибок имеют обязательные поля**
  - **Проверяет: Требования 6.4**

- [ ]* 10.2 Написать property-тест для логирования нормальных операций
  - **Property 22: Нормальные операции не логируются на уровне error**
  - **Проверяет: Требования 6.5**

- [x] 11. Реализовать устойчивость и логику повторных попыток
  - Добавить логику повторных попыток для неудачных API вызовов к M2 во время polling
  - Реализовать изоляцию ошибок для продолжения обработки после отдельных сбоев
  - Добавить экспоненциальную задержку для повторных попыток
  - Убедиться что множественные последовательные сбои не роняют систему
  - _Требования: 9.1, 9.2, 9.4_

- [ ]* 11.1 Написать property-тест для повторных попыток неудачного polling
  - **Property 29: Неудачные polling повторяются**
  - **Проверяет: Требования 9.1**

- [ ]* 11.2 Написать property-тест для изоляции запросов
  - **Property 30: Неудачные запросы изолированы**
  - **Проверяет: Требования 9.2**

- [ ]* 11.3 Написать property-тест для устойчивости системы
  - **Property 32: Множественные сбои не роняют систему**
  - **Проверяет: Требования 9.4**

- [x] 12. Собрать всё вместе в главном сервере
  - Инициализировать конфигурацию и logger
  - Создать экземпляры всех сервисов и клиентов
  - Запустить Express сервер для webhook endpoint
  - Инициализировать и запустить cron планировщик
  - Добавить graceful shutdown обработку
  - Добавить health check endpoint для мониторинга
  - _Требования: 7.1_

- [x] 13. Контрольная точка - Убедиться что все тесты проходят
  - Убедиться что все тесты проходят, спросить пользователя если возникнут вопросы.
