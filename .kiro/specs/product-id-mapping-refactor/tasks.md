# Implementation Plan: Рефакторинг маппинга product.id → offerId

## Задачи

- [x] 1. Создать ProductMappingStore для файлового хранилища
  - Создать класс `src/storage/productMappingStore.js`
  - Реализовать загрузку маппинга из JSON файла
  - Реализовать сохранение маппинга в JSON файл
  - Реализовать двунаправленный маппинг (product.id ↔ offerId)
  - Добавить file locking для предотвращения конфликтов
  - Добавить валидацию структуры JSON
  - Добавить обработку ошибок и логирование
  - _Требования: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.1 Написать unit тесты для ProductMappingStore
  - Тест загрузки валидного файла
  - Тест обработки невалидного JSON
  - Тест обработки отсутствующего файла
  - Тест сохранения маппинга
  - Тест получения offerId по product.id
  - Тест получения product.id по offerId
  - Тест добавления/удаления маппинга
  - _Требования: 1.1, 1.2, 1.3, 1.4_

- [x] 2. Рефакторинг MapperService для работы с product.id
  - Удалить метод `getOfferIdAttributeId()`
  - Удалить зависимость от атрибута offerId_M2
  - Обновить конструктор для использования ProductMappingStore
  - Переписать `loadMappings()` для загрузки из файла
  - Переименовать `mapOfferIdToExternalCode()` → `mapProductIdToOfferId()`
  - Переименовать `mapExternalCodeToOfferId()` → `mapOfferIdToProductId()`
  - Обновить `getAllOfferIds()` для работы с новым маппингом
  - Добавить `getAllProductIds()` для получения списка product.id
  - Обновить логирование и обработку ошибок
  - _Требования: 2.1, 2.2, 2.3, 2.4, 2.5, 6.4_

- [x] 2.1 Написать unit тесты для обновленного MapperService
  - Тест загрузки маппингов из ProductMappingStore
  - Тест маппинга product.id → offerId
  - Тест обратного маппинга offerId → product.id
  - Тест обработки несуществующих маппингов
  - Тест получения списков product.id и offerId
  - _Требования: 2.1, 2.2, 2.3, 2.4_

- [x] 2.2 Написать property тест для двунаправленного маппинга
  - **Property 1: Bidirectional mapping consistency**
  - **Validates: Requirements 2.2, 8.3**

- [x] 2.3 Написать property тест для целостности файла маппинга
  - **Property 2: Mapping file integrity**
  - **Validates: Requirements 1.1, 1.3**

- [x] 3. Упростить MoySkladClient - удалить работу с атрибутами
  - Удалить метод `getProductAttributes()`
  - Обновить `getProducts()` - убрать `expand=attributes`
  - Добавить метод `getProductById(productId)` для получения товара по ID
  - Обновить `getProductStock()` для работы с product.id
  - Обновить документацию методов
  - _Требования: 6.1, 6.2, 6.3_

- [x] 3.1 Обновить unit тесты для MoySkladClient
  - Удалить тесты для `getProductAttributes()`
  - Обновить тесты для `getProducts()` без атрибутов
  - Добавить тесты для `getProductById()`
  - Обновить тесты для `getProductStock()` с product.id
  - _Требования: 6.1, 6.2, 6.3_

- [x] 4. Обновить YandexClient для работы с offerId
  - Обновить `updateStocks()` - использовать offerId вместо offerId_M2
  - Обновить документацию параметров
  - Обновить логирование
  - _Требования: 2.5, 5.4_

- [x] 4.1 Обновить unit тесты для YandexClient
  - Обновить тесты для `updateStocks()` с offerId
  - Проверить корректность формата запроса
  - _Требования: 2.5, 5.4_

- [x] 5. Рефакторинг StockService для работы с product.id
  - Обновить `syncStocks()` для использования product.id из маппинга
  - Обновить `handleStockUpdate()` для обработки product.id из webhook
  - Изменить логику получения остатков - использовать product.id
  - Обновить маппинг: product.id → offerId → отправка в M2
  - Добавить обработку товаров без маппинга (пропускать с логом)
  - Обновить статистику синхронизации
  - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5.1 Обновить unit тесты для StockService
  - Тест синхронизации остатков с product.id
  - Тест обработки webhook с product.id
  - Тест обработки товаров без маппинга
  - Тест batch обработки остатков
  - _Требования: 5.1, 5.2, 5.3, 5.4_

- [x] 5.2 Написать property тест для полноты синхронизации остатков
  - **Property 5: Stock sync completeness**
  - **Validates: Requirements 5.1, 5.5**

- [x] 6. Рефакторинг OrderService для работы с offerId → product.id
  - Обновить `processOrder()` для маппинга offerId → product.id
  - Обновить `createMoySkladOrder()` для использования product.id в позициях
  - Добавить обработку позиций без маппинга (пропускать с логом)
  - Обновить логирование с новыми идентификаторами
  - _Требования: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 6.1 Обновить unit тесты для OrderService
  - Тест обработки заказа с offerId
  - Тест маппинга offerId → product.id для позиций
  - Тест создания заказа в МойСклад с product.id
  - Тест обработки позиций без маппинга
  - _Требования: 7.1, 7.2, 7.3, 7.4_

- [x] 6.2 Написать property тест для сохранения маппинга заказов
  - **Property 6: Order mapping preservation**
  - **Validates: Requirements 7.2, 7.3**

- [x] 6.3 Написать property тест для полноты обратного маппинга
  - **Property 7: Reverse mapping completeness**
  - **Validates: Requirements 8.2, 8.3**

- [x] 7. Обновить webhook endpoint для обработки product.id
  - Обновить `src/server.js` - парсинг product.id из webhook payload
  - Извлекать product.id из `event.meta.href`
  - Передавать product.id в StockService
  - Обновить логирование webhook событий
  - Добавить обработку ошибок парсинга
  - _Требования: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7.1 Обновить тесты для webhook endpoint
  - Тест парсинга product.id из payload
  - Тест обработки webhook с product.id
  - Тест обработки невалидного payload
  - Тест возврата HTTP 200 OK
  - _Требования: 4.1, 4.2, 4.4, 4.5_

- [x] 7.2 Написать property тест для идемпотентности обработки webhook
  - **Property 4: Webhook processing idempotency**
  - **Validates: Requirements 4.3, 4.4**

- [x] 8. Создать MigrationService для миграции данных
  - Создать класс `src/services/migrationService.js`
  - Реализовать `migrateFromAttributes()` - чтение товаров с атрибутом offerId
  - Создать маппинг product.id → offerId из атрибутов
  - Сохранить маппинг в файл через ProductMappingStore
  - Реализовать `backupCurrentMappings()` - создание резервной копии
  - Реализовать `validateMappings()` - проверка корректности
  - Добавить детальное логирование процесса миграции
  - _Требования: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 8.1 Написать unit тесты для MigrationService
  - Тест миграции из атрибутов в файл
  - Тест создания резервной копии
  - Тест валидации маппинга
  - Тест обработки ошибок миграции
  - _Требования: 10.1, 10.2, 10.3, 10.4_

- [x] 8.2 Написать property тест для сохранения данных при миграции
  - **Property 9: Migration data preservation**
  - **Validates: Requirements 10.2, 10.3**

- [x] 9. Создать CLI скрипт для миграции
  - Создать `scripts/migrate-to-file-mapping.js`
  - Загрузить конфигурацию и инициализировать сервисы
  - Запустить MigrationService.migrateFromAttributes()
  - Вывести статистику миграции
  - Добавить опции командной строки (--backup, --validate)
  - _Требования: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 10. Обновить конфигурацию и документацию
  - Добавить в `src/config.js` параметры для файла маппинга
  - Обновить `.env.example` с новыми параметрами
  - Обновить `README.md` с описанием новой архитектуры
  - Создать `docs/product-mapping-guide.md` с инструкциями
  - Обновить `docs/architecture-data-flow.md` с новой схемой
  - Добавить примеры файла маппинга в документацию
  - _Требования: 1.1, 3.1, 3.2, 3.3_

- [x] 11. Обновить инициализацию приложения
  - Обновить `src/server.js` - инициализация ProductMappingStore
  - Обновить создание MapperService с новыми зависимостями
  - Удалить вызов `getOfferIdAttributeId()` при старте
  - Добавить загрузку маппинга из файла при старте
  - Обновить обработку ошибок инициализации
  - _Требования: 1.1, 6.1, 6.4_

- [x] 12. Создать пример файла маппинга
  - Создать `data/product-mappings.example.json`
  - Добавить примеры маппингов с комментариями
  - Создать пустой `data/product-mappings.json` для продакшена
  - Добавить `.gitignore` правило для `data/product-mappings.json`
  - _Требования: 1.1, 1.2_

- [x] 13. Написать property тест для обработки пустого маппинга
  - **Property 10: Empty mapping handling**
  - **Validates: Requirements 2.3, 8.4**

- [x] 14. Написать integration тесты
  - End-to-end тест синхронизации остатков
  - End-to-end тест обработки заказов
  - Тест обработки webhook
  - Тест миграции данных
  - _Требования: 1.5, 2.5, 4.5, 5.5, 7.5, 10.5_

- [x] 15. Checkpoint - Запустить все тесты
  - Убедиться что все unit тесты проходят
  - Убедиться что все property тесты проходят
  - Убедиться что все integration тесты проходят
  - Проверить покрытие кода тестами
  - Если есть проблемы - спросить пользователя

- [x] 16. Выполнить миграцию данных в продакшене
  - Создать резервную копию текущих данных
  - Запустить CLI скрипт миграции
  - Проверить созданный файл маппинга
  - Валидировать маппинг
  - Обновить конфигурацию для использования файлового маппинга
  - _Требования: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 17. Обновить мониторинг и логирование
  - Добавить метрики для количества маппингов
  - Добавить метрики для успешных/неудачных lookup операций
  - Добавить метрики для пропущенных товаров
  - Обновить dashboard с новыми метриками
  - Добавить алерты для критических ошибок маппинга
  - _Требования: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 18. Final Checkpoint - Проверка изоляции M1/M2
  - Проверить что middleware не читает product.offerId
  - Проверить что M1 и M2 используют разные offerId
  - Проверить что M1 и M2 используют разные Campaign ID
  - Проверить что нет пересечений в обработке товаров
  - Запустить полный цикл синхронизации и проверить логи
  - Убедиться что все тесты проходят
  - Если есть проблемы - спросить пользователя
  - _Требования: 3.1, 3.2, 3.3, 3.4, 3.5_
