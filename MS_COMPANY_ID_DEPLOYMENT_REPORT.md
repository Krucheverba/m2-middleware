# Отчет о добавлении MS_COMPANY_ID

## Дата: 14 декабря 2025

## Выполненные работы

### 1. Добавление MS_COMPANY_ID в конфигурацию

✅ **Локально:**
- Добавлен `MS_COMPANY_ID=144131919` в `.env`
- Добавлен `MS_COMPANY_ID=144131919` в `.env.example`

✅ **В коде:**
- Добавлен `MS_COMPANY_ID` в `src/config.js`:
  - Чтение из переменной окружения
  - Добавлен в список обязательных параметров (required)
  - Добавлен в `toSafeObject()` для логирования
- Добавлен `this.companyId` в `src/api/moySkladClient.js`

### 2. Деплой на сервер

✅ **Обновление кода:**
- Код загружен на GitHub
- Код обновлен на сервере (commit: c3208fc)

✅ **Обновление конфигурации:**
- `MS_COMPANY_ID=144131919` добавлен в `.env` на сервере

✅ **Перезапуск приложения:**
- Приложение перезапущено через `ecosystem.config.js`
- Статус: **online** ✅
- Порт: 3001
- PID: 329484

### 3. Проверка работоспособности

✅ **Статус приложения:**
```
│ 8  │ m2-middleware  │ online  │ 1.0.0  │ fork  │ 329484  │ 66s  │ 0  │ 66.1mb │
```

✅ **Конфигурация загружена:**
- PORT: 3001
- MS_BASE: https://api.moysklad.ru/api/remap/1.2
- MS_COMPANY_ID: 144131919 ✅
- YANDEX_CAMPAIGN_ID: 198473170
- Маппинги: 102 товара

✅ **Сервисы запущены:**
- HTTP сервер на порту 3001
- Синхронизация остатков (каждые 10 минут)
- Polling заказов (каждые 5 минут)
- Polling отгрузок (каждые 5 минут)

### 4. Созданные скрипты

Для удобства управления созданы следующие скрипты:

1. `deploy-company-id-fix.sh` - Деплой обновлений на сервер
2. `check-company-id.sh` - Проверка MS_COMPANY_ID на сервере
3. `check-env-server.sh` - Проверка .env файла на сервере
4. `check-pm2-logs.sh` - Проверка PM2 логов
5. `check-server-logs.sh` - Проверка логов приложения
6. `check-config-version.sh` - Проверка версии кода на сервере
7. `restart-with-env.sh` - Перезапуск с обновлением переменных
8. `restart-with-ecosystem.sh` - Перезапуск через ecosystem.config.js
9. `tail-fresh-logs.sh` - Просмотр свежих логов

## Результат

✅ **MS_COMPANY_ID успешно добавлен и работает на сервере**

Приложение M2 Middleware запущено и работает с новой конфигурацией, включающей ID компании МойСклад (144131919), как требовала поддержка.

## Следующие шаги

Теперь можно:
1. Проверить работу API запросов к МойСклад
2. Убедиться, что ошибки 400 больше не возникают
3. Мониторить логи для подтверждения корректной работы

## Команды для мониторинга

```bash
# Проверить статус
ssh root@89.223.125.212 'pm2 status'

# Посмотреть логи
ssh root@89.223.125.212 'pm2 logs m2-middleware --lines 50'

# Проверить конфигурацию
ssh root@89.223.125.212 'cd /root/m2-middleware && cat .env | grep MS_'
```
