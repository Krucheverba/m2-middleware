#!/bin/bash

echo "üöÄ –î–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ YANDEX_TOKEN –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

SERVER="root@89.223.125.212"
APP_DIR="/root/m2-middleware"

# –ß–∏—Ç–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ .env
NEW_TOKEN=$(grep "^YANDEX_TOKEN=" .env | cut -d '=' -f2)

if [ -z "$NEW_TOKEN" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: YANDEX_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º .env"
  exit 1
fi

echo "‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º .env"

# –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ YANDEX_TOKEN –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh $SERVER "cd $APP_DIR && sed -i 's/^YANDEX_TOKEN=.*/YANDEX_TOKEN=$NEW_TOKEN/' .env"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–∏–ª—Å—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
UPDATED_TOKEN=$(ssh $SERVER "cd $APP_DIR && grep '^YANDEX_TOKEN=' .env | cut -d '=' -f2")

if [ "$UPDATED_TOKEN" = "$NEW_TOKEN" ]; then
  echo "‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
else
  echo "‚ùå –û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è"
  exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
ssh $SERVER "cd $APP_DIR && pm2 restart m2-middleware --update-env"

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
ssh $SERVER "cd $APP_DIR && pm2 status"

echo ""
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥:"
echo "  ssh $SERVER 'cd $APP_DIR && pm2 logs m2-middleware --lines 20'"
