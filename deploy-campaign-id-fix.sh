#!/bin/bash

# –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Campaign ID –Ω–∞ —Å–µ—Ä–≤–µ—Ä

set -e

SERVER="root@89.223.125.212"
APP_DIR="/root/m2-middleware"

echo "üöÄ –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è YANDEX_CAMPAIGN_ID –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo ""

ssh $SERVER << 'ENDSSH'
cd /root/m2-middleware

echo "üìã –®–ê–ì 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
git reset --hard
git pull

echo ""
echo "üìã –®–ê–ì 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
# –£–¥–∞–ª—è–µ–º MS_COMPANY_ID –µ—Å–ª–∏ –µ—Å—Ç—å
sed -i '/MS_COMPANY_ID=/d' .env

# –û–±–Ω–æ–≤–ª—è–µ–º YANDEX_CAMPAIGN_ID –Ω–∞ 144131919
if grep -q "YANDEX_CAMPAIGN_ID=" .env; then
    sed -i 's/YANDEX_CAMPAIGN_ID=.*/YANDEX_CAMPAIGN_ID=144131919/' .env
    echo "‚úÖ YANDEX_CAMPAIGN_ID –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ PORT
    sed -i '/PORT=/a YANDEX_CAMPAIGN_ID=144131919' .env
    echo "‚úÖ YANDEX_CAMPAIGN_ID –¥–æ–±–∞–≤–ª–µ–Ω"
fi

echo ""
echo "üìã –®–ê–ì 3: –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
cat .env

echo ""
echo "üìã –®–ê–ì 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 restart m2-middleware

echo ""
echo "‚è≥ –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥..."
sleep 5

echo ""
echo "üìã –®–ê–ì 5: –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 list | grep m2-middleware

echo ""
echo "üìã –®–ê–ì 6: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
pm2 logs m2-middleware --lines 30 --nostream

ENDSSH

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "üìù –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–¥ —Å GitHub"
echo "  ‚úÖ YANDEX_CAMPAIGN_ID=144131919 (–¥–ª—è M2)"
echo "  ‚úÖ –£–¥–∞–ª–µ–Ω MS_COMPANY_ID (–Ω–µ –Ω—É–∂–µ–Ω)"
echo "  ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
echo ""
