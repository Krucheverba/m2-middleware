# Скрипты миграции

## migrate-to-file-mapping.js

CLI скрипт для миграции маппинга `product.id → offerId` из кастомных атрибутов МойСклад в файловое хранилище.

### Назначение

Скрипт выполняет одноразовую миграцию данных из старой системы (использующей кастомный атрибут `offerId` в МойСклад) в новую систему (использующую файловое хранилище `data/product-mappings.json`).

### Требования

- Настроенные переменные окружения в `.env` файле
- `MS_TOKEN` - токен доступа к API МойСклад
- Доступ к API МойСклад для чтения товаров с атрибутами

### Использование

#### Через Node.js

```bash
# Простая миграция
node scripts/migrate-to-file-mapping.js

# Миграция с резервной копией
node scripts/migrate-to-file-mapping.js --backup

# Миграция с резервной копией и валидацией
node scripts/migrate-to-file-mapping.js --backup --validate

# Показать справку
node scripts/migrate-to-file-mapping.js --help
```

#### Через npm скрипты

```bash
# Простая миграция
npm run migrate-mappings

# Миграция с резервной копией
npm run migrate-mappings:backup

# Миграция с резервной копией и валидацией
npm run migrate-mappings:full
```

### Опции

- `--backup` - Создать резервную копию текущего файла маппинга перед миграцией
  - Резервная копия сохраняется в `data/backups/` с timestamp в имени файла
  - Если файл маппинга не существует, резервная копия не создается

- `--validate` - Валидировать маппинги после завершения миграции
  - Проверяет формат UUID для `product.id`
  - Проверяет отсутствие пустых значений
  - Проверяет отсутствие дубликатов `offerId`
  - Если валидация не прошла, скрипт завершается с кодом ошибки 1

- `--help`, `-h` - Показать справку по использованию

### Процесс миграции

1. **Инициализация компонентов**
   - Загрузка конфигурации из `.env`
   - Создание клиентов API и сервисов

2. **Создание резервной копии** (если указана опция `--backup`)
   - Проверка существования текущего файла маппинга
   - Создание директории `data/backups/` если не существует
   - Копирование файла с timestamp в имени

3. **Выполнение миграции**
   - Получение всех товаров из МойСклад с атрибутами
   - Извлечение маппинга `product.id → offerId` из атрибута `offerId`
   - Сохранение маппинга в файл `data/product-mappings.json`

4. **Валидация** (если указана опция `--validate`)
   - Проверка структуры файла маппинга
   - Проверка формата данных
   - Проверка на дубликаты и пустые значения

5. **Вывод статистики**
   - Количество обработанных товаров
   - Количество мигрированных маппингов
   - Количество пропущенных товаров
   - Список ошибок (если есть)

### Статистика миграции

После завершения миграции скрипт выводит детальную статистику:

```
============================================================
СТАТИСТИКА МИГРАЦИИ
============================================================
Всего товаров обработано:     150
Маппингов мигрировано:        145
Товаров пропущено:            5
Ошибок при обработке:         0
Длительность:                 12с
============================================================
```

### Результаты валидации

Если указана опция `--validate`, скрипт выводит результаты валидации:

```
============================================================
РЕЗУЛЬТАТЫ ВАЛИДАЦИИ
============================================================
Статус:                       ✓ ВАЛИДНО
Всего маппингов:              145
Валидных маппингов:           145
Невалидных маппингов:         0
Дубликатов offerId:           0
Пустых значений:              0
============================================================
```

### Обработка ошибок

Скрипт обрабатывает следующие типы ошибок:

1. **Ошибки API МойСклад**
   - Неверные учетные данные
   - Проблемы с сетевым подключением
   - Ошибки сервера МойСклад

2. **Ошибки файловой системы**
   - Недостаточно прав доступа
   - Недостаточно места на диске
   - Ошибки при создании резервной копии

3. **Ошибки валидации**
   - Невалидный формат `product.id` (не UUID)
   - Пустые значения в маппинге
   - Дубликаты `offerId`

При критической ошибке скрипт:
- Выводит детальное сообщение об ошибке
- Выводит stack trace для отладки
- Завершается с кодом ошибки 1

### Примеры использования

#### Первая миграция

```bash
# Выполнить миграцию с резервной копией и валидацией
npm run migrate-mappings:full
```

#### Повторная миграция (обновление данных)

```bash
# Создать резервную копию старого файла и выполнить миграцию
npm run migrate-mappings:backup
```

#### Быстрая миграция без проверок

```bash
# Простая миграция без резервной копии и валидации
npm run migrate-mappings
```

### Следующие шаги после миграции

1. **Проверить файл маппинга**
   ```bash
   cat data/product-mappings.json | jq .
   ```

2. **Проверить резервную копию** (если создавалась)
   ```bash
   ls -la data/backups/
   ```

3. **Перезапустить middleware**
   ```bash
   npm start
   ```

4. **Мониторить логи**
   ```bash
   tail -f logs/combined.log
   ```

### Проверяемые требования

Скрипт проверяет следующие требования из спецификации:

- **10.1** - Чтение товаров с атрибутом offerId из МойСклад
- **10.2** - Создание маппинга product.id → offerId
- **10.3** - Сохранение маппинга в файл `data/product-mappings.json`
- **10.4** - Логирование количества мигрированных записей
- **10.5** - Создание резервной копии старого файла маппинга

### Устранение неполадок

#### Ошибка: "Missing required configuration"

Убедитесь, что в `.env` файле настроены все необходимые переменные:
```bash
MS_TOKEN=your_moysklad_token
YANDEX_TOKEN=your_yandex_token
YANDEX_CAMPAIGN_ID=your_campaign_id
```

#### Ошибка: "EACCES: permission denied"

Убедитесь, что у вас есть права на запись в директорию `data/`:
```bash
chmod 755 data/
```

#### Ошибка: "МойСклад API error"

Проверьте:
- Правильность токена `MS_TOKEN`
- Доступность API МойСклад
- Наличие прав на чтение товаров

#### Валидация не прошла

Если валидация обнаружила проблемы:
1. Проверьте файл `data/product-mappings.json`
2. Исправьте невалидные записи вручную
3. Запустите валидацию повторно:
   ```bash
   node scripts/migrate-to-file-mapping.js --validate
   ```

### Дополнительная информация

- Скрипт использует `MigrationService` для выполнения миграции
- Все операции логируются через `logger`
- Скрипт безопасен для повторного запуска (перезаписывает файл маппинга)
- Резервные копии никогда не перезаписываются (используется timestamp)
