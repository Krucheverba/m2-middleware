# Проблема: Остатки не обновляются в М2 (403 Forbidden)

## Дата: 14 декабря 2025

## Симптомы

- Остатки не подтягиваются из МойСклад в Яндекс.Маркет M2
- Все 102 товара получают ошибку при синхронизации
- Результат последней синхронизации: **synced: 0, errors: 102**

## Причина

Яндекс.Маркет API возвращает **403 Forbidden** с сообщением **"Access denied"** при попытке обновить остатки через endpoint `/campaigns/198473170/offers/stocks`.

### Пример ошибки из логов:

```json
{
  "error": "Request failed with status code 403",
  "endpoint": "/campaigns/198473170/offers/stocks",
  "method": "PUT",
  "errorResponse": {
    "errors": [{
      "code": "FORBIDDEN",
      "message": "Access denied"
    }],
    "status": "ERROR"
  }
}
```

## Диагностика

✅ **МойСклад API работает** - данные успешно получаются
✅ **MS_COMPANY_ID добавлен** - конфигурация корректна
✅ **Приложение работает** - статус online
❌ **Яндекс.Маркет API отклоняет запросы** - нет прав на обновление остатков

## Решение

### 1. Проверить права токена в Яндекс.Маркет

Зайдите в личный кабинет Яндекс.Маркет:
1. Перейдите в **Настройки** → **API и модули** → **Токены авторизации**
2. Найдите токен для M2 (Campaign ID: 198473170)
3. Проверьте, что у токена есть права:
   - ✅ **Управление остатками** (stocks:write)
   - ✅ **Чтение остатков** (stocks:read)
   - ✅ **Управление товарами** (offers:write)

### 2. Если прав нет - создать новый токен

Если у текущего токена нет нужных прав:

1. Создайте новый токен с правами:
   - Управление остатками
   - Управление товарами
   - Чтение заказов
   - Управление заказами

2. Обновите токен в `.env`:
   ```bash
   YANDEX_TOKEN=новый_токен
   ```

3. Перезапустите приложение:
   ```bash
   ssh root@89.223.125.212 'cd /root/m2-middleware && pm2 restart m2-middleware'
   ```

### 3. Альтернатива: Использовать OAuth токен

Если API-key не работает, можно использовать OAuth токен:
- OAuth токены обычно имеют больше прав
- Документация: https://yandex.ru/dev/market/partner-api/doc/ru/concepts/authorization

## Проверка после исправления

После обновления токена запустите:

```bash
bash check-sync-results.sh
```

Должны увидеть:
- `synced: 102` (или близко к этому)
- `errors: 0`

## Текущий статус

- ❌ Синхронизация остатков НЕ работает
- ❌ Все товары получают 403 Forbidden
- ⚠️ Требуется обновление прав токена в Яндекс.Маркет

## Команды для мониторинга

```bash
# Проверить результаты синхронизации
bash check-sync-results.sh

# Запустить синхронизацию вручную
bash trigger-stock-sync.sh

# Посмотреть логи ошибок
ssh root@89.223.125.212 'tail -n 50 /root/m2-middleware/logs/error.log'
```
