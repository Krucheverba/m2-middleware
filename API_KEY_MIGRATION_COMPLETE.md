# Миграция на API-key токен - Завершено ✅

**Дата:** 14 декабря 2024  
**Статус:** Готово к деплою на сервер

---

## Что сделано

### 1. ✅ Обновлен YandexClient

**Файл:** `src/api/yandexClient.js`

**Изменения:**
```javascript
// Было:
headers: {
  'Authorization': `Bearer ${this.token}`,
  'Content-Type': 'application/json'
}

// Стало:
headers: {
  'Api-Key': this.token,
  'Content-Type': 'application/json'
}
```

**Результат:** YandexClient теперь использует новый формат заголовка `Api-Key` вместо устаревшего `Authorization: Bearer`.

---

### 2. ✅ Написаны тесты

#### Unit тест
**Файл:** `test-yandex-client-unit.js`

Добавлен тест 11, который проверяет:
- ✅ Заголовок `Api-Key` присутствует
- ✅ Заголовок `Authorization` отсутствует
- ✅ Токен передается без префикса `Bearer`

**Результат:** Все 11 тестов проходят успешно.

#### Property-based тест
**Файл:** `test-api-key-backward-compatibility-property.js`

Проверяет обратную совместимость всех методов API:
- ✅ `updateStocks` работает для 100 случайных наборов данных
- ✅ `getOrders` возвращает массив для 100 различных фильтров
- ✅ `getOrder` работает для 100 различных ID
- ✅ Все методы используют правильный Campaign ID

**Результат:** Проверено 350+ случайных комбинаций параметров, все тесты проходят.

---

### 3. ✅ Обновлена документация

#### `.env.example`
Добавлены комментарии о новом формате токена:
```env
# API-key токен (новый формат, рекомендуется вместо OAuth)
# Получите в личном кабинете: API и модули → Токены авторизации → Создать
# Формат: ACMA:xxxxx:xxxxx
# Документация: https://yandex.ru/dev/market/partner-api/doc/ru/concepts/api-key
YANDEX_TOKEN=
```

#### `README.md`
Добавлена секция "Получение API-key токена" с пошаговой инструкцией.

#### `docs/server-usage.md`
Обновлена таблица конфигурации и добавлена секция о получении API-key.

---

### 4. ✅ Обновлен скрипт деплоя

**Файл:** `deploy-token-update.sh`

Добавлены комментарии о новом формате токена и проверка формата при деплое.

---

## Проверка изоляции M1/M2

**Вопрос:** Не скомпрометирует ли смена токена изоляцию M1/M2?

**Ответ:** ✅ НЕТ, изоляция сохраняется!

**Причины:**
1. ✅ Изоляция гарантируется **Campaign ID**, а не форматом токена
2. ✅ M1 использует свой токен в встроенной интеграции МойСклад
3. ✅ M2 использует наш токен в middleware
4. ✅ Campaign ID остается неизменным (M2)
5. ✅ Маппинг остается прежним (только товары M2)

**Вывод:** Смена формата токена - это изменение только на уровне HTTP заголовков, не влияющее на логику разделения магазинов.

---

## Локальное тестирование

### Запуск тестов

```bash
# Unit тесты
node test-yandex-client-unit.js
# ✅ Все 11 тестов пройдены

# Property-based тесты
node test-api-key-backward-compatibility-property.js
# ✅ Проверено 350+ случайных комбинаций
```

### Результаты
- ✅ Все существующие тесты проходят
- ✅ Новые тесты проверяют формат заголовков
- ✅ Property-based тесты подтверждают обратную совместимость

---

## Готовность к деплою

### Что уже сделано локально
- ✅ Токен обновлен в `.env` (формат: `ACMA:8v4KdUCXRf8QqJq4jcJMAiTIvHOTUq6HEPPAx8pS:4db96dd3`)
- ✅ Код обновлен
- ✅ Тесты написаны и проходят
- ✅ Документация обновлена

### Следующие шаги (деплой на сервер)

#### Задача 5: Выполнить деплой на сервер

```bash
# 1. Запустить скрипт деплоя
./deploy-token-update.sh

# Скрипт выполнит:
# - Создаст бэкап старого .env
# - Скопирует новый .env с API-key токеном
# - Проверит формат токена
# - Перезапустит ТОЛЬКО процесс M2 (M1 не затронут)
# - Покажет логи для проверки
```

#### Задача 6: Проверить работу на сервере

После деплоя проверить:

1. **Health check:**
   ```bash
   curl https://maslahub.ru/m2/health
   ```
   Ожидаемый результат: `{"status":"ok",...}`

2. **Логи на наличие ошибок авторизации:**
   ```bash
   ssh root@89.223.125.212
   pm2 logs maslahub-m2 --lines 50
   ```
   Не должно быть ошибок 401 Unauthorized

3. **Синхронизация остатков:**
   Подождать 10 минут (интервал синхронизации) и проверить логи:
   ```
   Остатки обновлены в Яндекс.Маркет
   ```

4. **Получение заказов:**
   Подождать 5 минут (интервал polling) и проверить логи:
   ```
   Получено X заказов из Яндекс.Маркет
   ```

5. **M1 не затронут:**
   ```bash
   pm2 list
   # Убедиться что процесс M1 работает нормально
   ```

---

## Откат в случае проблем

Если что-то пойдет не так на сервере:

```bash
ssh root@89.223.125.212

# 1. Восстановить бэкап .env
cd /root/maslahub  # или путь к вашей директории M2
cp .env.backup-YYYYMMDD-HHMMSS .env

# 2. Перезапустить процесс M2
pm2 restart maslahub-m2

# 3. Проверить логи
pm2 logs maslahub-m2 --lines 50
```

---

## Контрольный список перед деплоем

- [x] Код обновлен (YandexClient использует Api-Key)
- [x] Тесты написаны и проходят
- [x] Документация обновлена
- [x] Токен обновлен локально в .env
- [x] Скрипт деплоя подготовлен
- [x] Проверена изоляция M1/M2
- [ ] Выполнен деплой на сервер
- [ ] Проверена работа на сервере
- [ ] Проверены логи на ошибки
- [ ] Проверена синхронизация остатков
- [ ] Проверено получение заказов

---

## Технические детали

### Формат токена
- **Старый:** OAuth токен (использовался с `Authorization: Bearer`)
- **Новый:** API-key в формате `ACMA:xxxxx:xxxxx` (используется с `Api-Key`)

### Изменения в коде
- **Файлов изменено:** 1 (`src/api/yandexClient.js`)
- **Строк изменено:** 1 (заголовок авторизации)
- **Тестов добавлено:** 2 (unit + property-based)
- **Документов обновлено:** 3 (`.env.example`, `README.md`, `docs/server-usage.md`)

### Обратная совместимость
- ✅ Все существующие методы работают без изменений
- ✅ Формат запросов не изменился
- ✅ Campaign ID не изменился
- ✅ Маппинг не изменился
- ✅ Изоляция M1/M2 сохранена

---

## Рекомендации Яндекса

Из письма поддержки:
> "Рекомендуем использовать API-key токен вместо OAuth, так как авторизация через OAuth токен устарела."

**Документация:** https://yandex.ru/dev/market/partner-api/doc/ru/concepts/api-key

---

**Подготовил:** Kiro AI  
**Дата:** 14 декабря 2024  
**Статус:** ✅ Готово к деплою

