# План рефакторинга: product.id → offerId маппинг

## Проблема

Текущая система использует кастомный атрибут `offerId_M2` в МойСклад, но это не работает потому что:

1. **МойСклад webhook** отправляет только `product.id`, а не значения атрибутов
2. **Яндекс.Маркет API** работает только с `offerId` (стандартное поле)
3. **M1 и M2** должны использовать разные `offerId` для одного товара

## Решение

Использовать **файловый маппинг** `product.id ↔ offerId` вместо кастомного атрибута.

### Пример маппинга:

```json
{
  "mappings": {
    "f8a2da33-bf0a-11ef-0a80-17e3002d7201": "8100-X-clean-EFE-5w-30-5L_DBSA"
  }
}
```

**Где:**
- **Ключ**: `product.id` из МойСклад (UUID)
- **Значение**: `offerId` для Яндекс M2

### Архитектура изоляции M1/M2:

```
МойСклад товар:
  product.id = "f8a2da33-bf0a-11ef-0a80-17e3002d7201"
  product.offerId = "8100-X-clean-EFE-5w-30-5L"

M1 (встроенная интеграция):
  ✅ Использует product.offerId = "8100-X-clean-EFE-5w-30-5L"
  ✅ Campaign ID M1

M2 (наш middleware):
  ✅ Использует маппинг → offerId = "8100-X-clean-EFE-5w-30-5L_DBSA"
  ✅ Campaign ID M2

Результат: ПОЛНАЯ ИЗОЛЯЦИЯ! ✅
```

## Основные изменения

### 1. Новый компонент: ProductMappingStore
- Загрузка/сохранение маппинга из JSON файла
- Двунаправленный маппинг: `product.id ↔ offerId`
- File locking для безопасности

### 2. Рефакторинг MapperService
- Убрать работу с атрибутом `offerId_M2`
- Использовать `ProductMappingStore`
- Методы: `mapProductIdToOfferId()` и `mapOfferIdToProductId()`

### 3. Упрощение MoySkladClient
- Удалить `getProductAttributes()`
- Убрать `expand=attributes` из запросов
- Работать только с `product.id`

### 4. Обновление StockService
- Синхронизация через `product.id`
- Webhook обработка с `product.id`
- Маппинг: `product.id → offerId → Яндекс M2`

### 5. Обновление OrderService
- Обработка заказов: `offerId → product.id`
- Создание заказов в МойСклад с `product.id`

### 6. MigrationService (новый)
- Миграция данных из атрибутов в файл
- Резервное копирование
- Валидация маппинга

## План выполнения

Всего **18 задач** в `.kiro/specs/product-id-mapping-refactor/tasks.md`

### Основные этапы:

1. **Задачи 1-2**: Создать ProductMappingStore и обновить MapperService
2. **Задачи 3-4**: Упростить API клиенты
3. **Задачи 5-6**: Обновить сервисы синхронизации и заказов
4. **Задача 7**: Обновить webhook endpoint
5. **Задачи 8-9**: Создать миграцию данных
6. **Задачи 10-12**: Обновить конфигурацию и документацию
7. **Задачи 13-14**: Property и integration тесты
8. **Задача 15**: Checkpoint - все тесты
9. **Задача 16**: Выполнить миграцию в продакшене
10. **Задачи 17-18**: Мониторинг и финальная проверка изоляции

## Гарантии безопасности

✅ **M1 не знает про M2**: Разные offerId, разные Campaign ID
✅ **M2 не влияет на M1**: Middleware работает только со своим маппингом
✅ **Полная изоляция**: Никаких пересечений в данных
✅ **Webhook безопасность**: Обрабатываются только товары из маппинга
✅ **Нет модификации МойСклад**: Middleware только читает данные

## Следующие шаги

1. Просмотреть спецификацию: `.kiro/specs/product-id-mapping-refactor/`
2. Подтвердить план
3. Начать выполнение задач по порядку

## Файлы спецификации

- `requirements.md` - Детальные требования (10 требований)
- `design.md` - Архитектура и дизайн (10 correctness properties)
- `tasks.md` - План реализации (18 задач)
